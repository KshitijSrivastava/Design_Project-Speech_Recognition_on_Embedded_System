#include "main.h"
#include "stm32f4xx_hal.h"

#include <stdint.h>
#include <stdbool.h>
#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include "classification_const.h"

float b_a[10][12] = 
{
{-0.7764342050747125,-0.071172142777496006,0.67976029962399709,0.67235244359427193,-0.29160885486385496,-0.69747888936368763,-0.47924138508656999,-1.5829204260826173,1.0064671471871156,0.86092845043572841,1.2855030969580041,-1.5970197884691499},
{1.8255064715322991,0.11512799381046231,1.3025782254027551,-0.057306382976340144,-1.0116611888868667,1.4495485148466403,0.15314437748363074,0.054268766348877319,0.55670072974668194,-1.0757618906053652,0.70600151453838367,1.5484399764778269},
{0.62071062862475224,-0.095126090380596481,-0.355189623892949,0.35430991587213506,0.034538639863171836,-1.168277069069606,1.3453509456685606,-1.7669539453129295,-0.25036229651985076,-0.7305280472472343,-1.0066351858737421,-1.116892210496423},
{-1.9828188237539286,-0.46282492476027437,0.092691208444166437,0.73359174080286027,-0.82816271221931981,-0.15172013236917214,0.13852889935168786,1.5728998841927451,-0.62375224204372981,0.14300423917744248,-1.3143906006970085,-0.52646784620547327},
{1.2350499627101943,0.45506129060555817,1.1069514708145383,0.49627869736999719,0.78947199924329248,-1.3413521844278657,1.1772193851686106,1.3812141458401677,1.1859080931165702,0.25628404217100154,-0.48838027818211821,1.2290501793929314},
{-0.13123824466419987,2.1701735171658463,0.062666203759492736,0.18876260769443265,1.0672797212988745,1.5031716908762234,-1.9092551967274149,1.1033274313831347,0.46891141500845968,0.60538876844762879,-0.19645490872194732,1.1790411614256151},
{-1.3466404843642739,0.26105686654280358,-0.71394651418441868,-2.2192540374610981,0.99418178283963221,-1.1329630410144831,-0.91414917410985619,-0.91674399178159782,0.45448926623119584,0.10903541087543479,-1.4796646661344628,-0.59383995469439177},
{-0.58785181055725011,0.39563989293845475,-1.5044637999364672,-0.25750675027549758,1.1916550407583892,-1.3225629138124866,-0.62698103976187924,0.40624396173948374,-0.88034917839093862,-0.59576858336746974,1.2279805278174649,0.53869961906180541},
{-0.63824806864022521,1.1888609042972873,-1.4089006735052652,0.37293285892694944,-0.79803382680771662,-1.0337796626035829,0.49292135639587686,-1.6770363004471616,0.92754799272804034,0.9510370663008737,-1.6128598058275265,1.5169471983766856},
{-0.99207511872162757,-0.17936894998725766,1.0767445596675684,-0.2566861955741076,1.3792121588316146,1.2701346504727946,0.91558529385684084,-0.50771126228223573,-1.0394016245215982,-0.92500273022029389,1.1803434736113136,0.51180965671334344}
};

void classification(float*mfcc,float*results){
	
	
	//printf("array a: %f\n", a[30]);
	float n1[12], a1[12], n2[10];
//	float *n1 = malloc(10*sizeof(float));
//	float *a1 = malloc(10*sizeof(float));
//	float *n2 = malloc(10*sizeof(float));
	float max = 0, sum = 0;
	
	
	for( int j=0; j<12; j++) {
		float tempVar = 0;
		for( int i=0; i<312; i++){
			if(j == 0){
					mfcc[i] = mfcc[i] - offset[i];
					mfcc[i] = mfcc[i] * gain[i];
					mfcc[i] = mfcc[i] - 1;
			}
			tempVar = tempVar + (a[j][i] * mfcc[i]);
			
		}
		n1[j] = tempVar;
		printf("n1[%d]: %f\n",j,n1[j]);
	}
		
	//input layer calculation n1, a1
	for( int i=0; i<12; i++) {
		n1[i] = n1[i] + b1[i];
	  printf("n1[%d]: %f\n",i,n1[i]);
		
		printf("exp(-2*n1[%d])= %f\n",i, exp(-2*n1[i]));
		
		a1[i] = 2/(1 + exp(-2*n1[i])) -1;
		printf("al[%d]: %f\n",i,a1[i]);
	}
	
	
		//printf("HARDFAULT 1)");
	//layer 2 calculation
	
	
	for( int i=0; i<10; i++) 
	{
		float tempNum = 0;
		for(int j=0; j<12; j++)
		{
			//float tempNum2 = 0;
			//printf("b_a[%d][%d] * a1[%d] : %f   +   ",i,j,i,b_a[i][j] * a1[j]);
			//n2[i] = n2[i] + ( b_a[i][j] * a1[j] );
			//tempNum2 = ( b_a[i][j] * a1[j] );
			tempNum = tempNum + ( b_a[i][j] * a1[j] );//tempNum2;
			
			//WORKS
			printf("[b_a[%d][%d] = %f * a1[%d] = %f]\n",i,j,b_a[i][j], j , a1[j]);
			//printf("tempNum2[%d] = %f\n", i, tempNum2);
			printf("tempNum[%d] = %f\n", i, tempNum);
		}
		//printf("\n");
		//printf("n2[%d]: %f\n",i,n2[i]);
		//printf("b2[%d]: %f\n",i,b2[i]);
		//n2[i] = n2[i] + b2[i];
		
		n2[i] = tempNum + b2[i];
		printf("n2[%d]: %f\n",i,n2[i]);
		//Find max
		if(n2[i] > max)
			max = n2[i];
	}
	
	//printf("MAX: %f\n", max);
	
	//Post processing
	for( int i=0; i<10; i++)
	{
			float tempNum3 = 0;
			tempNum3 = n2[i] - max;
		
			n2[i] = exp(tempNum3);
		
			printf("n2[%d]: %f\n",i,n2[i]);
			sum = sum + n2[i];
	}
	
	if (sum==0)
		sum = 1;
	
	//Classification
	for( int i=0; i<10; i++) {
		results[i] = n2[i]/sum;
		printf("results[%d] = %f\n",i,results[i]);
	}
	
}
